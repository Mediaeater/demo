<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ö - Cyclical Storytelling</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #2e5987;
            --secondary: #4d7cab;
            --light: #e1f0fa;
            --dark: #1a3b5d;
            --accent: #6c8eb7;
            --text: #2d3b48;
            --bg: #f5f8fb;
            --sage: #b6c9a5;
            --mist: #d3e0ea;
            --deep: #17304a;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }

        body {
            background-color: var(--bg);
            color: var(--text);
            line-height: 1.6;
            padding: 20px;
            background-image: 
                linear-gradient(to bottom, rgba(245,248,251,0.9), rgba(245,248,251,0.7)),
                url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><path fill="%23d3e0ea" d="M50 100c27.6 0 50-22.4 50-50S77.6 0 50 0 0 22.4 0 50s22.4 50 50 50zm0-90c22.1 0 40 17.9 40 40S72.1 90 50 90 10 72.1 10 50 27.9 10 50 10z"/></svg>');
        }

        @font-face {
            font-family: 'Arvo';
            src: url('https://fonts.googleapis.com/css2?family=Arvo&display=swap');
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            background: linear-gradient(135deg, var(--primary), var(--deep));
            color: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            position: relative;
            overflow: hidden;
        }

        header::after {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: 
                radial-gradient(circle at 20% 40%, rgba(255,255,255,0.1) 0%, transparent 20%),
                radial-gradient(circle at 80% 70%, rgba(255,255,255,0.1) 0%, transparent 25%);
            pointer-events: none;
        }

        h1 {
            font-family: 'Arvo', serif;
            font-size: 3rem;
            margin-bottom: 10px;
            letter-spacing: -1px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
        }

        .logo {
            font-size: 3.5rem;
            margin-bottom: 5px;
            line-height: 1;
            color: var(--sage);
        }

        .subtitle {
            font-size: 1.1rem;
            opacity: 0.85;
            font-weight: 300;
            max-width: 600px;
            margin: 0 auto;
        }

        .app-container {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 30px;
        }

        .sidebar {
            background-color: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            height: fit-content;
            border: 1px solid var(--mist);
        }

        .main-content {
            background-color: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            border: 1px solid var(--mist);
        }

        .section-title {
            font-size: 1.3rem;
            margin-bottom: 20px;
            color: var(--dark);
            padding-bottom: 8px;
            display: flex;
            align-items: center;
            font-weight: 600;
            position: relative;
        }

        .section-title::after {
            content: "";
            position: absolute;
            bottom: 0;
            left: 0;
            width: 60px;
            height: 3px;
            background-color: var(--sage);
            border-radius: 3px;
        }

        .section-title i {
            margin-right: 12px;
            color: var(--accent);
        }

        .form-group {
            margin-bottom: 25px;
            position: relative;
        }

        label {
            display: block;
            margin-bottom: 10px;
            font-weight: 500;
            color: var(--dark);
            font-size: 0.95rem;
        }

        input, textarea, select {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--mist);
            border-radius: 6px;
            font-size: 0.95rem;
            transition: all 0.3s ease;
            background-color: var(--light);
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(108, 142, 183, 0.15);
            background-color: white;
        }

        textarea {
            min-height: 120px;
            resize: vertical;
        }

        button {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 500;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-top: 5px;
        }

        button:hover {
            background-color: var(--secondary);
            transform: translateY(-2px);
            box-shadow: 0 2px 8px rgba(46, 89, 135, 0.2);
        }

        button i {
            margin-right: 8px;
        }

        .btn-secondary {
            background-color: var(--sage);
            color: var(--dark);
        }

        .btn-secondary:hover {
            background-color: #9bb48a;
        }

        .btn-small {
            padding: 8px 12px;
            font-size: 0.9rem;
        }

        .save-indicator {
            position: absolute;
            right: 0;
            top: 0;
            background-color: #e8f5e9;
            color: #2e7d32;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .save-indicator.visible {
            opacity: 1;
        }

        .card {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
            border-left: 4px solid var(--sage);
            transition: all 0.3s ease;
            border: 1px solid var(--mist);
        }

        .card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border-left-color: var(--accent);
        }

        .card-title {
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--dark);
            font-size: 1.1rem;
        }

        .card-content {
            color: var(--text);
            font-size: 0.95rem;
            line-height: 1.6;
        }

        .tabs {
            display: flex;
            border-bottom: 1px solid var(--mist);
            margin-bottom: 25px;
            overflow-x: auto;
        }

        .tab {
            padding: 12px 20px;
            cursor: pointer;
            font-weight: 500;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .tab.active {
            color: var(--primary);
            border-bottom-color: var(--sage);
        }

        .tab:hover:not(.active) {
            color: var(--secondary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .character-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .character-card {
            border-radius: 8px;
            padding: 15px;
            background-color: var(--light);
            border-left: 4px solid var(--accent);
        }

        .character-name {
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1.05rem;
        }

        .character-details {
            font-size: 0.9rem;
            color: var(--text);
            line-height: 1.5;
        }

        .tag {
            display: inline-block;
            background-color: var(--sage);
            color: var(--dark);
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.8rem;
            margin-right: 8px;
            margin-bottom: 8px;
            opacity: 0.9;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #777;
            background-color: var(--light);
            border-radius: 8px;
            border: 1px dashed var(--mist);
        }

        .empty-state i {
            font-size: 2.5rem;
            color: var(--accent);
            margin-bottom: 15px;
            opacity: 0.5;
        }

        .empty-state p {
            max-width: 400px;
            margin: 0 auto;
        }

        .theme-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 20px;
        }

        .scene-idea {
            background-color: #f6f9fc;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid var(--mist);
        }

        .scene-idea h3 {
            color: var(--primary);
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .timeline {
            position: relative;
            margin: 40px 0;
        }

        .timeline::after {
            content: '';
            position: absolute;
            width: 2px;
            background-color: var(--mist);
            top: 0;
            bottom: 0;
            left: 50%;
            margin-left: -1px;
        }

        .timeline-item {
            padding: 10px 40px;
            position: relative;
            width: 50%;
            box-sizing: border-box;
        }

        .timeline-item::after {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            background-color: var(--sage);
            border-radius: 50%;
            top: 15px;
            z-index: 1;
            border: 3px solid white;
        }

        .left {
            left: 0;
        }

        .right {
            left: 50%;
        }

        .left::after {
            right: -8px;
        }

        .right::after {
            left: -8px;
        }

        .timeline-content {
            padding: 20px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
            border: 1px solid var(--mist);
        }

        .timeline-content h3 {
            color: var(--primary);
            margin-bottom: 10px;
        }

        .storyboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .storyboard-card {
            background-color: white;
            border-radius: 8px;
            padding: 0;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            border: 1px solid var(--mist);
            transition: all 0.3s ease;
        }

        .storyboard-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
        }

        .storyboard-image {
            height: 150px;
            background-color: #f1f1f1;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #999;
            position: relative;
        }

        .storyboard-image::after {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(108,142,183,0.1) 0%, transparent 100%);
        }

        .storyboard-details {
            padding: 15px;
        }

        .storyboard-details h4 {
            color: var(--dark);
            margin-bottom: 5px;
        }

        .storyboard-details p {
            color: var(--text);
            font-size: 0.9rem;
        }

        /* Story stages in development section */
        .stage-selector {
            display: flex;
            margin-bottom: 20px;
            background-color: var(--light);
            border-radius: 6px;
            padding: 6px;
        }

        .stage-option {
            flex: 1;
            text-align: center;
            padding: 10px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--dark);
            border-radius: 4px;
            transition: all 0.3s ease;
        }

        .stage-option.active {
            background-color: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            color: var(--primary);
            font-weight: 600;
        }

        .stage-option .stage-number {
            display: block;
            margin-bottom: 5px;
            font-size: 1.2rem;
            opacity: 0.8;
        }

        .theme-suggestions {
            background-color: var(--light);
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
        }

        .theme-suggestions h4 {
            color: var(--dark);
            margin-bottom: 10px;
            font-size: 1rem;
        }

        .flex-row {
            display: flex;
            gap: 15px;
        }

        .flex-row .form-group {
            flex: 1;
        }

        @media (max-width: 992px) {
            .app-container {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .timeline::after {
                left: 31px;
            }

            .timeline-item {
                width: 100%;
                padding-left: 70px;
                padding-right: 25px;
            }

            .timeline-item::after {
                left: 21px;
            }

            .right {
                left: 0%;
            }

            .stage-selector {
                flex-wrap: wrap;
                gap: 6px;
            }

            .stage-option {
                flex: auto;
                min-width: calc(50% - 12px);
            }

            .flex-row {
                flex-direction: column;
                gap: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">Ö</div>
            <h1>Cyclical Storytelling</h1>
            <p class="subtitle">Weave interdependent perspectives into a circular narrative</p>
        </header>

        <div class="app-container">
            <div class="sidebar">
                <div class="section-title">
                    <i class="fas fa-layer-group"></i> Story Elements
                </div>

                <div class="tabs">
                    <div class="tab active" data-tab="core">Core</div>
                    <div class="tab" data-tab="characters">Characters</div>
                    <div class="tab" data-tab="loops">Echoes</div>
                    <div class="tab" data-tab="themes">Themes</div>
                </div>

                <div class="tab-content active" id="core-tab">
                    <div class="form-group">
                        <label for="coreEvent">Fracture Point:</label>
                        <textarea id="coreEvent" placeholder="The event that disrupts the initial equilibrium..."></textarea>
                        <button id="saveCoreEvent" class="btn-small"><i class="fas fa-save"></i> Save</button>
                        <span class="save-indicator" id="coreSaveIndicator">Saved</span>
                    </div>
                </div>

                <div class="tab-content" id="characters-tab">
                    <div class="form-group">
                        <div class="flex-row">
                            <div class="form-group">
                                <label for="characterName">Character Name:</label>
                                <input type="text" id="characterName" placeholder="Name">
                            </div>
                        </div>
                        
                        <label for="initialBelief">Initial Perspective:</label>
                        <textarea id="initialBelief" placeholder="Their understanding of the event"></textarea>
                        
                        <label for="initialFeeling">Emotional Resonance:</label>
                        <textarea id="initialFeeling" placeholder="Their emotional state regarding the event"></textarea>
                        
                        <button id="addCharacter"><i class="fas fa-user-plus"></i> Add Character</button>
                        <span class="save-indicator" id="characterSaveIndicator">Saved</span>
                    </div>
                </div>

                <div class="tab-content" id="loops-tab">
                    <div class="form-group">
                        <label for="loopDescription">Echo Description:</label>
                        <textarea id="loopDescription" placeholder="A parallel or related event that reverberates..."></textarea>
                        
                        <label for="loopCharacters">Connected Characters:</label>
                        <select id="loopCharacters" multiple>
                            <option value="">Select characters</option>
                        </select>
                        
                        <button id="addLoop"><i class="fas fa-plus-circle"></i> Add Echo</button>
                        <span class="save-indicator" id="loopSaveIndicator">Saved</span>
                    </div>
                </div>

                <div class="tab-content" id="themes-tab">
                    <div class="form-group">
                        <label>Thematic Currents:</label>
                        <div class="theme-list" id="currentThemesList">
                            <div class="empty-state" id="themesEmptyState">
                                <i class="fas fa-tags"></i>
                                <p>No themes added yet</p>
                            </div>
                        </div>
                        
                        <label for="themeInput">Add Theme:</label>
                        <input type="text" id="themeInput" placeholder="Recurring motif or idea">
                        <button id="addTheme"><i class="fas fa-plus"></i> Add Theme</button>
                        <span class="save-indicator" id="themeSaveIndicator">Added</span>

                        <div class="theme-suggestions">
                            <h4>Suggested Themes</h4>
                            <div class="theme-list" id="suggestedThemes">
                                <!-- AI will populate this -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="main-content">
                <div class="section-title">
                    <i class="fas fa-project-diagram"></i> Narrative Development
                </div>

                <div id="sceneDevelopment">
                    <div class="flex-row">
                        <div class="form-group" style="flex: 2">
                            <label for="sceneStage">Explore Stage:</label>
                            <div class="stage-selector">
                                <div class="stage-option" data-stage="1">
                                    <span class="stage-number">1</span>
                                    Fracture
                                </div>
                                <div class="stage-option" data-stage="2">
                                    <span class="stage-number">2</span>
                                    Unfolding
                                </div>
                                <div class="stage-option" data-stage="3">
                                    <span class="stage-number">3</span>
                                    Convergence
                                </div>
                                <div class="stage-option" data-stage="4">
                                    <span class="stage-number">4</span>
                                    Turning
                                </div>
                                <div class="stage-option" data-stage="5">
                                    <span class="stage-number">5</span>
                                    Reflection
                                </div>
                                <div class="stage-option" data-stage="6">
                                    <span class="stage-number">6</span>
                                    Closure
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="sceneIdeasContainer">
                        <div class="empty-state">
                            <i class="fas fa-book-open"></i>
                            <h3>Scene Development</h3>
                            <p>Generate and develop scenes based on your narrative elements. Select a stage to begin.</p>
                        </div>
                    </div>
                    <button id="generateScene" class="btn-secondary"><i class="fas fa-magic"></i> Generate Scene</button>
                </div>

                <div class="tab-content" id="story-tab">
                    <div class="timeline" id="storyOutline">
                        <div class="empty-state">
                            <i class="fas fa-list-ol"></i>
                            <h3>Story Outline</h3>
                            <p>Your full narrative structure will appear here as you develop your elements. The outline will show the progression through all six stages.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        class NarrativeOrb {
            constructor() {
                this.fracture_point = null;
                this.perspectives = {};
                this.echoes = [];
                this.current_stage = 0;
                this.stages = [
                    { name: "Fracture", description: "The initial disruption that sets everything in motion" },
                    { name: "Unfolding", description: "Multiple perspectives begin to emerge" },
                    { name: "Convergence", description: "Events and perspectives begin to intertwine" },
                    { name: "Turning", description: "A pivotal moment that changes everything" },
                    { name: "Reflection", description: "Characters process and respond to changes" },
                    { name: "Closure", description: "Circular resolution with transformed understanding" }
                ];
                this.themes = [];
            }

            setFracture(event_description) {
                this.fracture_point = event_description;
                return true;
            }

            addTheme(theme) {
                if (theme && !this.themes.includes(theme)) {
                    this.themes.push(theme);
                    this.suggestAdditionalThemes();
                    return true;
                }
                return false;
            }

            suggestAdditionalThemes() {
                const themeWords = this.themes.join(" ").toLowerCase();
                const themes = new Set(this.themes);
                
                if (themeWords.includes("love") || themeWords.includes("relationship")) {
                    themes.add("Connection and Isolation");
                    themes.add("Intimacy and Distance");
                }
                if (themeWords.includes("betray") || themeWords.includes("trust")) {
                    themes.add("Loyalty and Trust");
                    themes.add("Deception and Truth");
                }
                if (themeWords.includes("loss") || themeWords.includes("grief")) {
                    themes.add("Memory and Letting Go");
                    themes.add("Absence and Presence");
                }
                if (themeWords.includes("time")) {
                    themes.add("Cyclical Nature of Time");
                    themes.add("The Past's Influence");
                }
                
                return Array.from(themes).filter(theme => !this.themes.includes(theme));
            }

            addPerspective(character_name, initial_view = "", emotional_state = "") {
                if (character_name && !this.perspectives[character_name]) {
                    this.perspectives[character_name] = {
                        initial_belief: initial_view,
                        initial_feeling: emotional_state,
                        journey: []
                    };
                    return true;
                }
                return false;
            }

            addEcho(description, related_characters = []) {
                if (description) {
                    const new_echo = {
                        description: description,
                        characters: related_characters
                    };
                    this.echoes.push(new_echo);
                    return true;
                }
                return false;
            }

            generateSceneForStage(stage_number) {
                if (!this.fracture_point && stage_number > 1) {
                    return "Define your Fracture Point first to generate coherent scenes for later stages.";
                }

                if (stage_number < 1 || stage_number > 6) {
                    return "Stages are numbered 1-6. Choose accordingly.";
                }

                const stage = this.stages[stage_number - 1];
                const characters = Object.keys(this.perspectives);
                const themes = this.themes.join(", ");
                
                let sceneDescription = "";
                
                switch(stage_number) {
                    case 1:
                        if (this.fracture_point) {
                            sceneDescription = `**Fracture Moment:** ${this.fracture_point}\n`;
                            sceneDescription += "Show this event through unexpected, visceral details. How does the world look different after this moment?";
                        } else {
                            sceneDescription = "This is your inciting incident - the moment that changes everything. Build tension before the fracture, then show the immediate aftermath.";
                        }
                        break;
                        
                    case 2:
                        if (characters.length >= 2) {
                            const charA = characters[Math.floor(Math.random() * characters.length)];
                            let charB = charA;
                            while (charB === charA && characters.length > 1) {
                                charB = characters[Math.floor(Math.random() * characters.length)];
                            }
                            sceneDescription = `**Intersecting Views:** ${charA} and ${charB} discuss or remember the event differently.\n`;
                            sceneDescription += `Show their contrasting perspectives through dialogue, actions, or thought processes. ${charA} sees ______, while ${charB} believes ______.`;
                        } else if (characters.length === 1) {
                            sceneDescription = `**Deepening Perspective:** Follow ${characters[0]} as they process the Fracture.\n`;
                            sceneDescription += "Show their internal monologue juxtaposed with external actions. What do they notice now that they missed before?";
                        } else {
                            sceneDescription = "Introduce at least two characters with differing viewpoints on the Fracture. Show the event through their contrasting lenses.";
                        }
                        break;
                        
                    case 3:
                        if (this.echoes.length > 0) {
                            const echo = this.echoes[Math.floor(Math.random() * this.echoes.length)];
                            const connectedChars = echo.characters.length > 0 
                                ? echo.characters.join(" and ") 
                                : characters.length > 0 
                                    ? characters.join(" and ") 
                                    : "your characters";
                            sceneDescription = `**Echo Effect:** ${echo.description}\n`;
                            sceneDescription += `This smaller event mirrors the Fracture in these ways ______. Show how ${connectedChars} respond similarly or differently than before.`;
                        } else {
                            sceneDescription = "Introduce an event that echoes the Fracture but on a personal scale. How does this smaller moment complicate or reveal truths about the larger one?";
                        }
                        break;
                        
                    case 4:
                        if (characters.length > 0) {
                            const char = characters[Math.floor(Math.random() * characters.length)];
                            sceneDescription = `**Turning Point:** ${char} reaches a moment of irreversible change.\n`;
                            sceneDescription += "This could be a decision, revelation, or action. Show the exact moment when their understanding shifts. What do they realize now?";
                        } else {
                            sceneDescription = "A pivotal scene where one character's perspective fundamentally changes. This could be an epiphany, betrayal, or moment of clarity that alters everything.";
                        }
                        break;
                        
                    case 5:
                        if (characters.length >= 1) {
                            sceneDescription = "**Reflective Space:** Characters process the changes.\n";
                            if (characters.length === 1) {
                                sceneDescription += `Show ${characters[0]} in a quiet moment, reflecting on how their understanding has shifted since the Fracture. What do they see now that they couldn't before?`;
                            } else {
                                sceneDescription += "Show multiple characters in different states of processing—some accepting, some resisting the new reality. Contrast their responses.";
                            }
                        } else {
                            sceneDescription = "A moment of pause and reflection after the Turning Point. Show how characters assimilate or resist the changes that have occurred.";
                        }
                        break;
                        
                    case 6:
                        if (this.fracture_point) {
                            sceneDescription = "**Circular Closure:** Return to where you began, but transformed.\n";
                            sceneDescription += `Echo elements from the Fracture (${this.fracture_point.substring(0, 30)}...) but show how everything is different now. End with a single resonant detail that captures the journey.`;
                        } else {
                            sceneDescription = "The ending should mirror the beginning but with transformed understanding. Show how perspectives have changed while suggesting the cycle continues.";
                        }
                        break;
                }
                
                return {
                    title: `${stage_number}. ${stage.name}`,
                    description: stage.description,
                    content: sceneDescription,
                    themes: themes
                };
            }

            getNarrativeOutline() {
                let outline = "";
                
                for (let i = 0; i < this.stages.length; i++) {
                    const stage = this.stages[i];
                    const positionClass = i % 2 === 0 ? "left" : "right";
                    const scene = this.generateSceneForStage(i+1);
                    
                    outline += `
                        <div class="timeline-item ${positionClass}">
                            <div class="timeline-content">
                                <h3>${i+1}. ${stage.name}</h3>
                                <p>${scene.content}</p>
                                ${scene.themes ? `<div class="theme-list">${scene.themes.split(", ").map(theme => `<span class="tag">${theme}</span>`).join('')}</div>` : ''}
                            </div>
                        </div>
                    `;
                }
                
                return outline;
            }
        }

        // Create Narrative Orb
        const orb = new NarrativeOrb();

        // DOM Elements
        const coreEventInput = document.getElementById('coreEvent');
        const saveCoreEventBtn = document.getElementById('saveCoreEvent');
        const coreSaveIndicator = document.getElementById('coreSaveIndicator');
        const characterNameInput = document.getElementById('characterName');
        const initialBeliefInput = document.getElementById('initialBelief');
        const initialFeelingInput = document.getElementById('initialFeeling');
        const addCharacterBtn = document.getElementById('addCharacter');
        const characterSaveIndicator = document.getElementById('characterSaveIndicator');
        const loopDescriptionInput = document.getElementById('loopDescription');
        const loopCharactersSelect = document.getElementById('loopCharacters');
        const addLoopBtn = document.getElementById('addLoop');
        const loopSaveIndicator = document.getElementById('loopSaveIndicator');
        const themeInput = document.getElementById('themeInput');
        const addThemeBtn = document.getElementById('addTheme');
        const themeSaveIndicator = document.getElementById('themeSaveIndicator');
        const currentThemesList = document.getElementById('currentThemesList');
        const themesEmptyState = document.getElementById('themesEmptyState');
        const suggestedThemesList = document.getElementById('suggestedThemes');
        const generateSceneBtn = document.getElementById('generateScene');
        const sceneIdeasContainer = document.getElementById('sceneIdeasContainer');
        const storyOutlineContainer = document.getElementById('storyOutline');
        const stageOptions = document.querySelectorAll('.stage-option');

        // Set default active stage
        let currentStage = 1;
        document.querySelector(`.stage-option[data-stage="1"]`).classList.add('active');

        // Stage selection
        stageOptions.forEach(option => {
            option.addEventListener('click', () => {
                stageOptions.forEach(opt => opt.classList.remove('active'));
                option.classList.add('active');
                currentStage = parseInt(option.dataset.stage);
            });
        });

        // Event Listeners
        saveCoreEventBtn.addEventListener('click', () => {
            const event = coreEventInput.value.trim();
            if (event) {
                const result = orb.setFracture(event);
                if (result) {
                    showSaveIndicator(coreSaveIndicator);
                    updateOutline();
                    updateThemeSuggestions();
                }
            }
        });

        addCharacterBtn.addEventListener('click', () => {
            const name = characterNameInput.value.trim();
            const belief = initialBeliefInput.value.trim();
            const feeling = initialFeelingInput.value.trim();
            
            if (!name) return;
            
            const result = orb.addPerspective(name, belief, feeling);
            if (result) {
                showSaveIndicator(characterSaveIndicator);
                characterNameInput.value = '';
                initialBeliefInput.value = '';
                initialFeelingInput.value = '';
                updateOutline();
                updateCharacterDropdowns();
            }
        });

        addLoopBtn.addEventListener('click', () => {
            const description = loopDescriptionInput.value.trim();
            const selectedCharacters = Array.from(loopCharactersSelect.selectedOptions)
                .map(option => option.value)
                .filter(value => value !== "");
            
            if (!description) return;
            
            const result = orb.addEcho(description, selectedCharacters);
            if (result) {
                showSaveIndicator(loopSaveIndicator);
                loopDescriptionInput.value = '';
                loopCharactersSelect.selectedIndex = 0;
                updateOutline();
            }
        });

        addThemeBtn.addEventListener('click', () => {
            const theme = themeInput.value.trim();
            if (theme) {
                const result = orb.addTheme(theme);
                if (result) {
                    showSaveIndicator(themeSaveIndicator);
                    themeInput.value = '';
                    updateThemeDisplay();
                    updateOutline();
                    updateThemeSuggestions();
                }
            }
        });

        generateSceneBtn.addEventListener('click', () => {
            const sceneData = orb.generateSceneForStage(currentStage);
            
            if (sceneIdeasContainer.querySelector('.empty-state')) {
                sceneIdeasContainer.innerHTML = '';
            }
            
            const sceneCard = document.createElement('div');
            sceneCard.className = 'scene-idea';
            sceneCard.innerHTML = `
                <h3>${sceneData.title}: ${sceneData.description}</h3>
                <p>${sceneData.content}</p>
                ${sceneData.themes ? `<div class="theme-list">${sceneData.themes.split(", ").map(theme => `<span class="tag">${theme}</span>`).join('')}</div>` : ''}
            `;
            
            sceneIdeasContainer.prepend(sceneCard);
        });

        // Helper functions
        function showSaveIndicator(element) {
            element.classList.add('visible');
            setTimeout(() => {
                element.classList.remove('visible');
            }, 2000);
        }

        function updateCharacterDropdowns() {
            // Clear existing options (except first placeholder)
            while (loopCharactersSelect.options.length > 1) {
                loopCharactersSelect.remove(1);
            }
            
            // Add current characters
            const characters = Object.keys(orb.perspectives);
            characters.forEach(char => {
                const option = document.createElement('option');
                option.value = char;
                option.textContent = char;
                loopCharactersSelect.appendChild(option);
            });
        }

        function updateThemeDisplay() {
            const themes = orb.themes;
            
            if (themes.length === 0) {
                currentThemesList.innerHTML = themesEmptyState.outerHTML;
            } else {
                currentThemesList.innerHTML = themes.map(theme => 
                    `<span class="tag">${theme}</span>`
                ).join('');
            }
        }

        function updateThemeSuggestions() {
            const suggestions = orb.suggestAdditionalThemes();
            
            if (suggestions.length === 0) {
                suggestedThemesList.innerHTML = '<span style="color:#777">Add some themes to see suggestions</span>';
            } else {
                suggestedThemesList.innerHTML = suggestions.map(theme => 
                    `<span class="tag">${theme}</span>`
                ).join('');
            }
        }

        function updateOutline() {
            if ((!orb.fracture_point || orb.fracture_point.trim() === '') && 
                Object.keys(orb.perspectives).length === 0 && 
                orb.echoes.length === 0) {
                storyOutlineContainer.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-list-ol"></i>
                        <h3>Story Outline</h3>
                        <p>Your full narrative structure will appear here as you develop your elements.</p>
                    </div>
                `;
                return;
            }
            
            storyOutlineContainer.innerHTML = orb.getNarrativeOutline();
        }

        // Initial setup
        updateCharacterDropdowns();
        updateThemeDisplay();
        updateThemeSuggestions();
        updateOutline();
    </script>
</body>
</html>